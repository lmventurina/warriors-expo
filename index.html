<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project J√≥honaa º√©√≠ | Cloud Command Center</title>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-deep: #050a10;
            --bg-panel: #0f1623;
            --text-main: #e6edf3;
            --text-muted: #8b949e;
            --safe: #40E0D0; /* Turquoise */
            --warn: #CC5500; /* Burnt Orange */
            --solar: #FFD700; /* Solar Yellow */
            --danger: #ff4d4d;
            --border: 1px solid #30363d;
            --font-tech: 'Courier New', Courier, monospace;
            --font-ui: system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            height: 100vh; 
            overflow: hidden; 
            background-image: 
                linear-gradient(rgba(15, 22, 35, 0.95), rgba(5, 10, 16, 0.98)),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2340E0D0' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .text-mono { font-family: var(--font-tech); }
        .text-solar { color: var(--solar); }
        .text-safe { color: var(--safe); }
        .text-warn { color: var(--warn); }

        /* --- BUTTONS --- */
        .btn { padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-family: var(--font-tech); transition: 0.2s; }
        .btn-primary { background: var(--safe); color: #000; }
        .btn-primary:hover { background: #7fffd4; }
        .btn-admin { background: transparent; border: 1px solid var(--warn); color: var(--warn); }
        .btn-admin:hover { background: rgba(204, 85, 0, 0.2); }
        .btn-logout { background: #2c3e50; color: #fff; padding: 8px 16px; font-size: 0.8rem; }
        .btn-del { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 4px 8px; font-size: 0.7rem; }
        .btn-del:hover { background: var(--danger); color: #fff; }

        /* --- DASHBOARD STRUCTURE --- */
        .dashboard-container { height: 100vh; display: grid; grid-template-rows: 60px 1fr; }
        header { background: var(--bg-panel); border-bottom: var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .content-area { display: flex; height: 100%; overflow: hidden; }
        .sidebar { width: 280px; background: rgba(15, 22, 35, 0.9); border-right: var(--border); padding: 20px 0; overflow-y: auto; }
        .nav-group-title { padding: 0 20px; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-top: 25px; margin-bottom: 10px; font-weight: bold; letter-spacing: 1px; }
        .nav-link { padding: 12px 20px; color: var(--text-main); text-decoration: none; border-left: 3px solid transparent; cursor: pointer; font-size: 0.9rem; display: block; transition: 0.2s; }
        .nav-link:hover { background: rgba(255,255,255,0.05); }
        .nav-link.active { background: rgba(64, 224, 208, 0.1); border-left-color: var(--safe); color: var(--safe); }
        .teacher-mode .nav-link.active { background: rgba(204, 85, 0, 0.1); border-left-color: var(--warn); color: var(--warn); }
        .workspace { flex: 1; padding: 40px; overflow-y: auto; scroll-behavior: smooth; }

        /* --- CONTENT CARDS --- */
        .card { background: var(--bg-panel); border: var(--border); padding: 25px; border-radius: 8px; margin-bottom: 25px; line-height: 1.6; }
        .card h2 { color: var(--solar); margin-bottom: 15px; font-family: var(--font-tech); font-size: 1.5rem; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .card h3 { color: var(--safe); margin-top: 20px; margin-bottom: 10px; font-size: 1.1rem; }
        
        /* --- ACADEMIC ELEMENTS --- */
        .source-material { background: #1a2332; border-left: 4px solid var(--solar); padding: 15px; margin-bottom: 20px; font-size: 0.9rem; }
        .source-material h4 { margin: 0 0 10px 0; color: #fff; font-family: var(--font-tech); }
        
        /* --- FORMS & INPUTS --- */
        .t-chart { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: #333; border: 1px solid #333; margin: 20px 0; }
        .t-chart-header { background: #1a2332; padding: 12px; text-align: center; font-weight: bold; color: var(--solar); font-size: 0.8rem; }
        .t-chart-cell { background: #0d1117; padding: 10px; }
        textarea { width: 100%; height: 150px; background: transparent; border: none; color: #fff; font-family: inherit; resize: none; outline: none; padding: 5px; line-height: 1.4; }
        
        .router-config { background: #000; border: 1px solid var(--border); padding: 20px; border-radius: 8px; max-width: 600px; font-family: var(--font-tech); }
        .config-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        select.auth-input { text-align: left; }

        .checklist-item { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .checklist-item input { margin-right: 15px; transform: scale(1.5); accent-color: var(--safe); }

        /* --- SIMULATIONS --- */
        .mitm-visualizer { height: 150px; background: #000; border: 1px solid #333; border-radius: 8px; position: relative; overflow: hidden; margin: 20px 0; }
        .packet { position: absolute; top: 50%; left: -20px; width: 15px; height: 15px; background: var(--safe); border-radius: 2px; transform: translateY(-50%); animation: drift 4s infinite linear; }
        .hacker-node { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: var(--warn); font-size: 1.5rem; text-align: center; }
        @keyframes drift { 0% { left: 0%; } 45% { background: var(--safe); } 50% { background: var(--warn); top: 30px; } 55% { background: var(--warn); top: 50%; } 100% { left: 100%; } }

        .status-box { padding: 15px; border-radius: 6px; margin-top: 15px; font-weight: bold; text-align: center; display: none; }
        .status-box.safe { background: rgba(64, 224, 208, 0.1); border: 1px solid var(--safe); color: var(--safe); display: block; }
        .status-box.danger { background: rgba(255, 77, 77, 0.1); border: 1px solid var(--danger); color: var(--danger); display: block; animation: flash 1s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- TEACHER OPS --- */
        .plan-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; flex-wrap: wrap; }
        .plan-tab { background: transparent; border: none; color: #888; cursor: pointer; font-weight: bold; padding: 5px 10px; }
        .plan-tab.active { color: var(--solar); border-bottom: 2px solid var(--solar); }
        .plan-content { display: none; animation: fadeIn 0.3s; }
        .plan-content.active { display: block; }
        
        .lesson-meta { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .meta-tag { background: #1e293b; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #334155; }
        .lesson-section { margin-bottom: 20px; border-left: 2px solid #333; padding-left: 15px; }
        .lesson-section h4 { color: #bbb; margin-bottom: 5px; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }

        .slide-frame-wrapper { width: 100%; height: 600px; background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .slide-frame-wrapper iframe { width: 100%; height: 100%; border: none; }

        /* --- OPS BOARD PROGRESS BAR --- */
        .progress-track { display: flex; gap: 5px; }
        .phase-pill {
            padding: 4px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
            background: #1e293b;
            color: #555;
            cursor: default;
            border: 1px solid #333;
        }
        .phase-pill.active {
            background: rgba(64, 224, 208, 0.2);
            color: var(--safe);
            border-color: var(--safe);
            cursor: pointer;
            font-weight: bold;
        }
        .phase-pill.active:hover {
            background: var(--safe);
            color: #000;
        }

        /* --- LANDING --- */
        #landing-view { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .hero-title { font-size: 3.5rem; background: -webkit-linear-gradient(0deg, var(--solar), var(--safe)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; text-align: center; }
        .access-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px; }
        .access-card { background: rgba(255, 255, 255, 0.03); border: 1px solid #333; padding: 40px; border-radius: 12px; cursor: pointer; text-align: center; width: 350px; transition: 0.3s; }
        .access-card:hover { border-color: var(--safe); transform: translateY(-5px); }
        
        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: var(--bg-panel); border: 1px solid var(--warn); width: 100%; max-width: 450px; padding: 40px; border-radius: 12px; text-align: center; }
        .auth-input { width: 100%; padding: 15px; margin: 10px 0; background: #000; border: 1px solid #444; color: var(--solar); text-align: center; font-size: 1.1rem; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- LANDING VIEW -->
    <div id="landing-view">
        <h1 class="hero-title">PROJECT J√ìHONAA º√â√ç v4.1</h1>
        <p style="color: var(--text-muted); font-size: 1.2rem; margin-top: 10px;">Cloud-Enabled Command Center</p>
        <div class="access-grid">
            <div class="access-card" onclick="app.openStudentAuth()">
                <div style="font-size: 3rem; margin-bottom: 10px;">üõ°Ô∏è</div>
                <h3 class="text-safe text-mono">STUDENT TASK FORCE</h3>
                <button class="btn btn-primary" style="margin-top:20px">ENTER MISSION</button>
            </div>
            <div class="access-card" onclick="app.openAuthModal()">
                <div style="font-size: 3rem; margin-bottom: 10px;">‚ö°</div>
                <h3 class="text-warn text-mono">COMMAND CENTER</h3>
                <button class="btn btn-admin" style="margin-top:20px">INSTRUCTOR</button>
            </div>
        </div>
    </div>

    <!-- STUDENT DASHBOARD -->
    <div id="student-dashboard" class="dashboard-container hidden">
        <header>
            <div class="brand"><span>‚òÄÔ∏è</span> J√ìHONAA º√â√ç <span id="st-team-tag" class="text-safe" style="font-size: 0.8rem; border: 1px solid var(--safe); padding: 3px 8px; border-radius: 4px; margin-left: 10px;">UNIT</span></div>
            <button class="btn btn-logout" onclick="app.logout()">DISCONNECT</button>
        </header>
        <div class="content-area">
            <aside class="sidebar">
                <div class="nav-group-title">Mission Briefing</div>
                <a class="nav-link active" onclick="app.studentRoute('mission')">üì° Scenario Overview</a>
                
                <div class="nav-group-title">Phase 1: Foundation</div>
                <a class="nav-link" onclick="app.studentRoute('p1-history')">üìò History: Coal to Solar</a>
                <a class="nav-link" onclick="app.studentRoute('p1-chem')">üß™ Chem: Battery Lab</a>
                
                <div class="nav-group-title">Phase 2: The Attack</div>
                <a class="nav-link" onclick="app.studentRoute('p2-mitm')">‚ö†Ô∏è MitM Data Injection</a>
                <a class="nav-link" onclick="app.studentRoute('p2-math')">üßÆ Math: Load Balance</a>
                
                <div class="nav-group-title">Phase 3: The Defense</div>
                <a class="nav-link" onclick="app.studentRoute('p3-harden')">üõ°Ô∏è Network Hardening</a>
                <a class="nav-link" onclick="app.studentRoute('p3-grant')">üìù ELA: Grant Proposal</a>
                
                <div class="nav-group-title">Phase 4: Expo</div>
                <a class="nav-link" onclick="app.studentRoute('p4-checklist')">üèÅ Final Deliverables</a>
            </aside>
            <main class="workspace" id="st-workspace"></main>
        </div>
    </div>

    <!-- TEACHER DASHBOARD -->
    <div id="teacher-dashboard" class="dashboard-container hidden teacher-mode">
        <header>
            <div class="brand"><span>‚ö°</span> COMMAND CENTER <span class="text-warn" style="font-size: 0.8rem; border: 1px solid var(--warn); padding: 3px 8px; border-radius: 4px; margin-left: 10px;">ADMIN</span></div>
            <button class="btn btn-logout" onclick="app.logout()">SECURE LOGOUT</button>
        </header>
        <div class="content-area">
            <aside class="sidebar">
                <div class="nav-group-title">Monitoring</div>
                <a class="nav-link active" onclick="app.teacherRoute('ops')">üìä Live Ops Board</a>
                <div class="nav-group-title">Instruction</div>
                <a class="nav-link" onclick="app.teacherRoute('slides')">üìΩÔ∏è Class Presentation</a>
                <a class="nav-link" onclick="app.teacherRoute('plans')">üìÇ 5E Lesson Plans</a>
                <a class="nav-link" onclick="app.teacherRoute('vault')">üîê Solution Vault</a>
            </aside>
            <main class="workspace" id="tr-workspace"></main>
        </div>
    </div>

    <!-- MODALS -->
    <div id="tr-auth-modal" class="modal-overlay hidden">
        <div class="auth-box">
            <h2 class="text-warn text-mono">ADMIN ACCESS</h2>
            <input type="password" id="tr-pass" class="auth-input" placeholder="Enter NPHS Key">
            <button class="btn btn-admin" style="width:100%" onclick="app.verifyTeacher()">AUTHORIZE</button>
            <button class="btn" style="background:transparent; color:#666; margin-top:10px" onclick="app.closeAuth()">CANCEL</button>
        </div>
    </div>

    <div id="st-auth-modal" class="modal-overlay hidden">
        <div class="auth-box" style="border-color: var(--safe)">
            <h2 class="text-safe text-mono">TASK FORCE LOGIN</h2>
            <div id="st-login-f">
                <input type="text" id="l-team" class="auth-input" placeholder="Unit Name">
                <input type="password" id="l-pass" class="auth-input" placeholder="Password">
                <button class="btn btn-primary" style="width:100%" onclick="app.loginStudent()">CONNECT</button>
                <p style="margin-top:15px; font-size:0.8rem; color:#666">Don't have a unit? <a href="#" onclick="app.stAuthMode('reg')" style="color:var(--safe)">Register here</a></p>
            </div>
            <div id="st-reg-f" class="hidden">
                <input type="text" id="r-team" class="auth-input" placeholder="New Unit Name">
                <input type="text" id="r-mems" class="auth-input" placeholder="Operatives (Lead, Mem2, etc)">
                <input type="password" id="r-pass" class="auth-input" placeholder="Set Password">
                <button class="btn btn-primary" style="width:100%" onclick="app.regStudent()">INITIALIZE UNIT</button>
                <p style="margin-top:15px; font-size:0.8rem; color:#666"><a href="#" onclick="app.stAuthMode('login')" style="color:var(--safe)">Back to login</a></p>
            </div>
            <button class="btn" onclick="app.closeAuth()" style="background:transparent; color:#666; margin-top:10px">CANCEL</button>
        </div>
    </div>

    <!-- NEW: TEAM DATA MODAL -->
    <div id="team-details-modal" class="modal-overlay hidden">
        <div class="auth-box" style="border-color: var(--safe); max-width: 600px; text-align: left;">
            <h2 class="text-safe" id="td-title" style="margin-bottom: 10px;">TEAM DATA</h2>
            <div id="td-content" style="max-height: 400px; overflow-y: auto; margin: 20px 0; color: #ccc; font-size: 0.9rem; line-height: 1.5;"></div>
            <button class="btn" onclick="document.getElementById('team-details-modal').classList.add('hidden')" style="background:transparent; color:#666; width: 100%;">CLOSE LOG</button>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyACGYC9jJDjNd5w_W2MJcJv4ioYlRlm1qc",
            authDomain: "warriors-expo.firebaseapp.com",
            projectId: "warriors-expo",
            storageBucket: "warriors-expo.firebasestorage.app",
            messagingSenderId: "1020710425782",
            appId: "1:1020710425782:web:a0cce30dd85bfc28c74217",
            measurementId: "G-ES2KRJ6GSW"
        };
        // ----------------------------------------

        // Initialize Firebase
        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);

        // --- EMBEDDED SLIDE DECK (Integrated Curriculum Matrix) ---
        const SLIDE_HTML = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><style>*{box-sizing:border-box}body{background-color:#020408;display:grid;place-items:center;margin:0;min-height:100vh;font-family:sans-serif;color:#e2e8f0}.slide-container{background-color:#0f172a;width:100%;height:100%;position:relative;overflow:hidden;border:1px solid #1e293b;display:none;flex-direction:column}.slide-container.active{display:flex}.slide-header{height:60px;background:#0f172a;border-bottom:2px solid #334155;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:10}.header-title{font-weight:800;font-size:18px;color:#fff;letter-spacing:1px}.header-phase{color:#40e0d0;font-weight:700}.content-grid{display:grid;grid-template-columns:200px 1fr;height:100%}.track-sidebar{background:#1e293b;padding:20px;display:flex;flex-direction:column;gap:10px;border-right:1px solid #334155}.track-card{padding:10px;border-radius:4px;background:#0f172a;border:1px solid #334155;color:#94a3b8;font-size:0.8rem}.track-card.active{border-color:#40e0d0;background:rgba(64,224,208,0.1);color:#fff}.lesson-area{padding:30px;overflow-y:auto;background:radial-gradient(circle at top right,#1e293b 0%,#0f172a 40%)}.day-block{margin-bottom:30px;border-left:4px solid #40e0d0;padding-left:20px}.day-title{color:#40e0d0;font-size:14px;font-weight:bold;display:block;margin-bottom:5px}.lesson-title{font-size:24px;font-weight:700;margin:0 0 10px 0;color:#fff}.tag{background:#334155;padding:2px 8px;border-radius:3px;font-size:12px;color:#cbd5e1;margin-right:5px}.depth-box{background:rgba(0,0,0,0.3);padding:15px;border-radius:6px;border:1px solid #334155;margin-top:15px}.depth-header{color:#ffd700;font-weight:700;margin-bottom:5px;font-size:12px}.activity-list{list-style:none;padding:0;margin:0;font-size:0.9rem}.activity-list li{margin-bottom:8px;padding-left:15px;position:relative;line-height:1.4;color:#cbd5e1}.activity-list li::before{content:'‚ñπ';position:absolute;left:0;color:#40e0d0}.controls{position:fixed;bottom:20px;right:20px;display:flex;gap:10px}.c-btn{background:#40e0d0;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold}</style></head><body>
        <!-- SLIDE 1 -->
        <div class="slide-container active" id="s1"><div style="text-align:center;margin-top:150px"><div style="font-size:60px">‚òÄÔ∏è</div><h1 style="color:#ffd700;font-size:40px">INTEGRATED CURRICULUM</h1><p>Project J√≥honaa º√©√≠: 8-Week Matrix</p></div></div>
        <!-- SLIDE 2 -->
        <div class="slide-container" id="s2"><div class="slide-header"><div class="header-title">PHASE 1: FOUNDATION</div><div class="header-phase">WEEKS 1-2</div></div><div class="content-grid"><div class="track-sidebar"><div class="track-card active">üìú History</div><div class="track-card">üß™ Science</div></div><div class="lesson-area"><div class="day-block"><span class="day-title">DAY 1: THE LEGACY</span><h2 class="lesson-title">From Black Mesa to Blackouts</h2><div style="margin-bottom:10px"><span class="tag">NM-SS.9-12</span><span class="tag">5E: Engage</span></div><div class="depth-box"><div class="depth-header">INSTRUCTIONAL DEPTH</div><ul class="activity-list"><li><strong>Hook:</strong> Photos of NGS smokestacks demolition.</li><li><strong>Activity:</strong> Analyze 'Classified Intel' on coal revenue.</li><li><strong>Output:</strong> T-Chart: Economic vs Ecological.</li></ul></div></div></div></div></div>
        <!-- SLIDE 3 -->
        <div class="slide-container" id="s3"><div class="slide-header"><div class="header-title">PHASE 2: THE ATTACK</div><div class="header-phase">WEEKS 3-4</div></div><div class="content-grid"><div class="track-sidebar"><div class="track-card active">üíÄ Cyber</div><div class="track-card">üßÆ Math</div></div><div class="lesson-area"><div class="day-block"><span class="day-title">DAY 9: PHYSICS OF FAILURE</span><h2 class="lesson-title">Calculating the Surge</h2><div style="margin-bottom:10px"><span class="tag">HS-CED.A.4</span><span class="tag">5E: Explain</span></div><div class="depth-box"><div class="depth-header">OHM'S LAW APP</div><ul class="activity-list"><li><strong>Formula:</strong> P = I x V</li><li><strong>Problem:</strong> 5000W / 120V = 41.67A</li><li><strong>Result:</strong> 41A > 20A Breaker. Trip confirmed.</li></ul></div></div></div></div></div>
        <!-- SLIDE 4 -->
        <div class="slide-container" id="s4"><div class="slide-header"><div class="header-title">PHASE 3: DEFENSE</div><div class="header-phase">WEEKS 5-6</div></div><div class="content-grid"><div class="track-sidebar"><div class="track-card active">üõ°Ô∏è Hardening</div><div class="track-card">üìù ELA</div></div><div class="lesson-area"><div class="day-block"><span class="day-title">DAY 13: THE PROPOSAL</span><h2 class="lesson-title">Writing for Resources</h2><div style="margin-bottom:10px"><span class="tag">W.9-10.1</span><span class="tag">5E: Elaborate</span></div><div class="depth-box"><div class="depth-header">RHETORIC</div><ul class="activity-list"><li><strong>Audience:</strong> US Dept of Energy.</li><li><strong>Evidence:</strong> Cite Math data (Surge risk).</li><li><strong>Drafting:</strong> Use App Grant Module.</li></ul></div></div></div></div></div>
        <div class="controls"><button class="c-btn" onclick="m(-1)">PREV</button><button class="c-btn" onclick="m(1)">NEXT</button></div><script>let c=1;const t=4;function m(d){document.getElementById('s'+c).classList.remove('active');c+=d;if(c<1)c=1;if(c>t)c=t;document.getElementById('s'+c).classList.add('active')}<\/script></body></html>`;

        const ADMIN_KEY = "NPHS2026";

        // Global App Object attached to window for HTML click handlers
        window.app = {
            state: { team: null, role: null, page: 'mission', ws: {} },

            init: function() {
                // Check local session to see if we should auto-route, 
                // but verify with DB if possible. For simplicity, we trust local session for role.
                const session = localStorage.getItem('j_session_cloud');
                if(session) {
                    const s = JSON.parse(session);
                    s.role === 'st' ? this.enterStudent(s.team) : (s.role === 'tr' ? this.enterTeacher() : null);
                }
            },

            hideViews: function() {
                ['landing-view', 'student-dashboard', 'teacher-dashboard', 'tr-auth-modal', 'st-auth-modal', 'team-details-modal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
            },

            // --- STUDENT ROUTING ---
            studentRoute: async function(page) {
                this.state.page = page;
                const ws = document.getElementById('st-workspace');
                document.querySelectorAll('#student-dashboard .nav-link').forEach(n => n.classList.remove('active'));
                
                // Get latest data from Cloud before rendering
                const docRef = doc(db, "teams", this.state.team);
                const docSnap = await getDoc(docRef);
                const ws_data = docSnap.exists() ? (docSnap.data().worksheets || {}) : {};
                this.state.ws = ws_data; // Sync state

                if(page === 'mission') {
                    ws.innerHTML = `<div class="card"><h2>MISSION BRIEF: PROJECT J√ìHONAA º√â√ç</h2><p><strong>Goal:</strong> Secure the Kayenta Smart Grid from "Blackout_25" hackers.</p><p><strong>Task:</strong> Complete 4 phases of training in History, Chemistry, Math, and Cyber Defense.</p></div>`;
                } else if(page === 'p1-history') {
                    ws.innerHTML = `
                        <div class="card">
                            <h2>PHASE 1: HISTORY LOG</h2>
                            <div class="source-material">
                                <h4>üìÅ CLASSIFIED INTEL: NGS CLOSURE (2019)</h4>
                                <p>For 45 years, the Navajo Generating Station (NGS) was the largest coal plant in the West. It provided hundreds of high-paying jobs but consumed billions of gallons of water and emitted massive carbon. Its closure devastated the local economy but opened the door for "Energy Sovereignty" via solar.</p>
                            </div>
                            <p><strong>Directive:</strong> Compare the economic and cultural impact of the Coal Era vs. the Solar Future.</p>
                            <div class="t-chart"><div class="t-chart-header">COAL ERA (Economic Focus)</div><div class="t-chart-header">SOLAR ERA (Sovereignty Focus)</div><div class="t-chart-cell"><textarea id="w-p1-coal" placeholder="List jobs, revenue, environmental cost...">${ws_data.p1_coal||''}</textarea></div><div class="t-chart-cell"><textarea id="w-p1-solar" placeholder="List ownership, sustainability, new challenges...">${ws_data.p1_solar||''}</textarea></div></div><button class="btn btn-primary" onclick="window.app.saveWS('p1')">SAVE LOG</button>
                        </div>`;
                } else if(page === 'p1-chem') {
                    ws.innerHTML = `<div class="card"><h2>PHASE 1: BATTERY LAB</h2><p>Record your Saltwater Battery findings. Remember: Galvanic cells convert chemical energy into electrical energy.</p><div class="router-config"><label>Anode Metal (Negative):</label><input id="w-p1-anode" class="auth-input" value="${ws_data.p1_anode||''}"><label>Cathode Metal (Positive):</label><input id="w-p1-cathode" class="auth-input" value="${ws_data.p1_cathode||''}"><label>Measured Voltage (V):</label><input id="w-p1-volts" class="auth-input" value="${ws_data.p1_volts||''}" type="number"></div><button class="btn btn-primary" style="margin-top:10px" onclick="window.app.saveWS('p1c')">SYNC DATA</button></div>`;
                } else if(page === 'p2-mitm') {
                    ws.innerHTML = `<div class="card"><h2>PHASE 2: ATTACK SIM</h2><p>Visualizing Man-in-the-Middle Injection.</p><div class="mitm-visualizer"><div class="hacker-node">üíÄ BLACKOUT_25</div><div class="packet"></div></div><p>The hacker changes the packet payload from <strong>{status: '10%'}</strong> to <strong>{status: '100%'}</strong> in transit. The grid stops charging, believing the battery is full.</p></div>`;
                } else if(page === 'p2-math') {
                    // UPDATED: Inputs now have 'w-' IDs so they save to the DB
                    ws.innerHTML = `<div class="card"><h2>PHASE 2: LOAD CALC</h2><p><strong>Problem:</strong> Home needs 5000W. Grid voltage is 120V. Calculate Current (I).</p><div class="router-config"><label>Power (P - Watts):</label><input id="w-p2-watts" class="auth-input" value="${ws_data.p2_watts || '5000'}"><label>Voltage (V - Volts):</label><input id="w-p2-volts" class="auth-input" value="${ws_data.p2_volts || '120'}"><button class="btn btn-primary" onclick="window.app.runCalc()">CALCULATE</button><div id="calc-status" class="status-box"></div><button class="btn btn-primary" style="margin-top:15px; width:100%;" onclick="window.app.saveWS('p2')">SAVE DATA</button></div></div>`;
                } else if(page === 'p3-harden') {
                    ws.innerHTML = `
                        <div class="card">
                            <h2>PHASE 3: NETWORK HARDENING</h2>
                            <p><strong>Objective:</strong> Configure the Home Gateway to block the MitM attack.</p>
                            <div class="router-config">
                                <div class="config-row">
                                    <span>Encryption Protocol:</span>
                                    <select id="conf-enc" class="auth-input" style="width:150px; padding:5px;"><option>OPEN</option><option>WEP (Weak)</option><option>WPA3 (Secure)</option></select>
                                </div>
                                <div class="config-row">
                                    <span>SSID Broadcast:</span>
                                    <select id="conf-ssid" class="auth-input" style="width:150px; padding:5px;"><option>Show</option><option>Hide</option></select>
                                </div>
                                <div class="config-row">
                                    <span>Firewall Rule:</span>
                                    <select id="conf-fw" class="auth-input" style="width:150px; padding:5px;"><option>Allow All</option><option>Block All</option><option>Whitelist Only</option></select>
                                </div>
                                <button class="btn btn-primary" onclick="window.app.checkSecurity()">APPLY CONFIG</button>
                                <div id="sec-res" class="status-box"></div>
                            </div>
                        </div>`;
                } else if(page === 'p3-grant') {
                    ws.innerHTML = `<div class="card"><h2>PHASE 3: GRANT PROPOSAL</h2><p>Draft your funding request to the DOE. Use data from Phase 1 (Sovereignty) and Phase 2 (Threats).</p><textarea id="w-p3-grant" style="background:#000; padding:10px; height:200px" placeholder="Write proposal here...">${ws_data.p3_grant||''}</textarea><button class="btn btn-primary" style="margin-top:10px" onclick="window.app.saveWS('p3g')">SAVE DRAFT</button></div>`;
                } else if(page === 'p4-checklist') {
                    // UPDATED: Checkboxes now have 'w-' IDs and use current state for checked status
                    const c1 = ws_data.p4_c1 === "true" ? "checked" : "";
                    const c2 = ws_data.p4_c2 === "true" ? "checked" : "";
                    const c3 = ws_data.p4_c3 === "true" ? "checked" : "";
                    const c4 = ws_data.p4_c4 === "true" ? "checked" : "";
                    const c5 = ws_data.p4_c5 === "true" ? "checked" : "";
                    ws.innerHTML = `<div class="card"><h2>PHASE 4: EXPO CHECKLIST</h2><p>Ensure all items are ready for the presentation.</p><div class="checklist-item"><input type="checkbox" id="w-p4-c1" ${c1}> 1. T-Chart Poster (History)</div><div class="checklist-item"><input type="checkbox" id="w-p4-c2" ${c2}> 2. Battery Demo (Science)</div><div class="checklist-item"><input type="checkbox" id="w-p4-c3" ${c3}> 3. Surge Calculation (Math)</div><div class="checklist-item"><input type="checkbox" id="w-p4-c4" ${c4}> 4. Grant Proposal Printed (ELA)</div><div class="checklist-item"><input type="checkbox" id="w-p4-c5" ${c5}> 5. Network Diagram (Cyber)</div><button class="btn btn-primary" style="margin-top:15px;" onclick="window.app.saveWS('p4')">SYNC PROGRESS</button></div>`;
                }
                this.updateOps(page);
            },

            // --- DATA LOGIC (FIRESTORE) ---
            saveWS: async function(cx) {
                const wsData = this.state.ws; 
                document.querySelectorAll('input[id^="w-"], textarea[id^="w-"]').forEach(i => {
                    const key = i.id.replace('w-','').replace(/-/g,'_');
                    // Check if it's a checkbox
                    if (i.type === 'checkbox') {
                        wsData[key] = i.checked ? "true" : "false";
                    } else {
                        wsData[key] = i.value;
                    }
                });
                
                // SAVE TO CLOUD
                try {
                    const teamRef = doc(db, "teams", this.state.team);
                    await updateDoc(teamRef, { worksheets: wsData });
                    alert("‚úÖ Mission Intelligence Synced to Cloud.");
                } catch(e) {
                    console.error(e);
                    alert("Error syncing to cloud. Check console.");
                }
            },

            runCalc: function() {
                const i = (document.getElementById('w-p2-watts').value / document.getElementById('w-p2-volts').value).toFixed(2);
                const box = document.getElementById('calc-status');
                if(i > 20) {
                    box.innerText = `WARNING: ${i} AMPS. BREAKER TRIPPED! SYSTEM FAILURE.`;
                    box.className = "status-box danger";
                } else {
                    box.innerText = `Current: ${i} Amps. System Stable.`;
                    box.className = "status-box safe";
                }
            },

            checkSecurity: function() {
                const enc = document.getElementById('conf-enc').value;
                const fw = document.getElementById('conf-fw').value;
                const box = document.getElementById('sec-res');
                if(enc === 'WPA3 (Secure)' && fw === 'Whitelist Only') {
                    box.innerText = "NETWORK SECURED. PACKETS ENCRYPTED.";
                    box.className = "status-box safe";
                } else {
                    box.innerText = "SECURITY WEAK. VULNERABILITY DETECTED.";
                    box.className = "status-box danger";
                }
            },

            updateOps: async function(p) {
                try {
                    const teamRef = doc(db, "teams", this.state.team);
                    await updateDoc(teamRef, { lastPhase: p });
                } catch(e) { console.log("Ops update silent fail"); }
            },

            // --- TEACHER ROUTING ---
            teacherRoute: function(page) {
                const ws = document.getElementById('tr-workspace');
                document.querySelectorAll('#teacher-dashboard .nav-link').forEach(n => n.classList.remove('active'));
                
                if(page === 'ops') {
                    // REAL-TIME LISTENER FOR TEACHER
                    ws.innerHTML = `<h2 class="text-warn text-mono">LIVE OPS BOARD (CLOUD STREAM)</h2><div class="team-table-container" style="background:var(--bg-panel); border:1px solid #333; border-radius:8px; overflow:hidden"><table class="team-table" style="width:100%; border-collapse:collapse"><thead style="background:#1a2332; text-align:left"><tr><th style="padding:10px">Unit</th><th>Operatives</th><th>Progress</th><th>Action</th></tr></thead><tbody id="ops-body"><tr><td colspan="4" style="padding:20px; text-align:center">Connecting to satellite...</td></tr></tbody></table></div>`;
                    
                    const q = collection(db, "teams");
                    onSnapshot(q, (snapshot) => {
                        let rows = "";
                        snapshot.forEach((doc) => {
                            const d = doc.data();
                            const lp = d.lastPhase || 'mission';
                            
                            // Determine active phase for highlighting
                            const p1 = lp.includes('p1') ? 'active' : '';
                            const p2 = lp.includes('p2') ? 'active' : '';
                            const p3 = lp.includes('p3') ? 'active' : '';
                            const p4 = lp.includes('p4') ? 'active' : '';

                            // Click handlers for badges to view data
                            const badgeHTML = `
                                <div class="progress-track">
                                    <span class="phase-pill ${p1}" onclick="window.app.viewTeamProgress('${d.team}', 'p1')">P1</span>
                                    <span class="phase-pill ${p2}" onclick="window.app.viewTeamProgress('${d.team}', 'p2')">P2</span>
                                    <span class="phase-pill ${p3}" onclick="window.app.viewTeamProgress('${d.team}', 'p3')">P3</span>
                                    <span class="phase-pill ${p4}" onclick="window.app.viewTeamProgress('${d.team}', 'p4')">P4</span>
                                </div>
                            `;

                            rows += `<tr>
                                <td class="text-safe" style="font-weight:bold;">${d.team}</td>
                                <td style="color:#bbb;">${d.mems}</td>
                                <td>${badgeHTML}</td>
                                <td><button class="btn-del" onclick="window.app.deleteTeam('${d.team}')">Remove</button></td>
                            </tr>`;
                        });
                        document.getElementById('ops-body').innerHTML = rows || '<tr><td colspan="4" style="padding:20px; text-align:center">No active units.</td></tr>';
                    });

                } else if(page === 'slides') {
                    ws.innerHTML = `<div class="card" style="height:100%; display:flex; flex-direction:column"><h2>CLASS PRESENTATION</h2><div class="slide-frame-wrapper"><iframe id="slide-viewer"></iframe></div></div>`;
                    const doc = document.getElementById('slide-viewer').contentWindow.document;
                    doc.open(); doc.write(SLIDE_HTML); doc.close();
                } else if(page === 'plans') {
                    ws.innerHTML = `
                        <div class="card">
                            <h2 class="text-warn">5E LESSON PLANS</h2>
                            <div class="plan-tabs">
                                <button class="plan-tab active" onclick="window.app.tab('p1')">PHASE 1</button>
                                <button class="plan-tab" onclick="window.app.tab('p2')">PHASE 2</button>
                                <button class="plan-tab" onclick="window.app.tab('p3')">PHASE 3</button>
                                <button class="plan-tab" onclick="window.app.tab('p4')">PHASE 4</button>
                            </div>
                            
                            <div id="tab-p1" class="plan-content active">
                                <h3>Phase 1: Foundation (Weeks 1-2)</h3>
                                <div class="lesson-meta"><span class="meta-tag">History</span><span class="meta-tag">Chem</span><span class="meta-tag">Vocab: Sovereignty, Galvanic</span></div>
                                <div class="lesson-section"><h4>Engage</h4><p>Show slide on NGS closure. Ask: "Where does our power come from now?"</p></div>
                                <div class="lesson-section"><h4>Explore</h4><p>Students research NGS vs Solar stats and fill out the T-Chart in the app.</p></div>
                                <div class="lesson-section"><h4>Explain</h4><p>Discuss the concept of "Energy Sovereignty." Introduce battery chemistry.</p></div>
                                <div class="lesson-section"><h4>Elaborate</h4><p>Lab: Build Lemon/Saltwater batteries. Measure Voltage.</p></div>
                                <div class="lesson-section"><h4>Evaluate</h4><p>Check submitted T-Charts and Voltage data in Ops Board.</p></div>
                            </div>
                            <div id="tab-p2" class="plan-content"><h3>Phase 2: The Attack (Weeks 3-4)</h3><p>Content hidden for brevity (same as v3.1)...</p></div>
                            <div id="tab-p3" class="plan-content"><h3>Phase 3: The Defense (Weeks 5-6)</h3><p>Content hidden for brevity (same as v3.1)...</p></div>
                            <div id="tab-p4" class="plan-content"><h3>Phase 4: Expo (Weeks 7-8)</h3><p>Content hidden for brevity (same as v3.1)...</p></div>
                        </div>
                    `;
                } else if(page === 'vault') {
                    ws.innerHTML = `<div class="card"><h2 class="text-warn">SOLUTION VAULT</h2><p><strong>Math Key:</strong> I = 41.6 Amps.</p></div>`;
                }
            },

            // --- ADMIN ACTIONS ---
            deleteTeam: async function(teamName) {
                if(confirm(`Are you sure you want to PERMANENTLY delete Team "${teamName}"?`)) {
                    await deleteDoc(doc(db, "teams", teamName));
                }
            },

            viewTeamProgress: async function(teamName, phase) {
                const docRef = doc(db, "teams", teamName);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const d = snap.data();
                    const w = d.worksheets || {};
                    let content = '';

                    if (phase.includes('p1')) {
                        content = `<h3>Phase 1 Data</h3>
                        <p><strong>Coal Era:</strong> ${w.p1_coal || 'No Data'}</p>
                        <p><strong>Solar Era:</strong> ${w.p1_solar || 'No Data'}</p>
                        <p><strong>Battery:</strong> Anode: ${w.p1_anode}, ${w.p1_volts}V</p>`;
                    } else if (phase.includes('p2')) {
                        content = `<h3>Phase 2 Math Data</h3>
                        <p><strong>Power Input:</strong> ${w.p2_watts || 'N/A'} Watts</p>
                        <p><strong>Voltage Input:</strong> ${w.p2_volts || 'N/A'} Volts</p>
                        <p>Note: Teacher should verify calculations manually.</p>`;
                    } else if (phase.includes('p3')) {
                        content = `<h3>Phase 3 Grant</h3><div style="background:#111; padding:10px;">${w.p3_grant || 'No Draft'}</div>`;
                    } else if (phase.includes('p4')) {
                        content = `<h3>Phase 4 Checklist</h3>
                        <ul>
                            <li>T-Chart: ${w.p4_c1 === "true" ? "‚úÖ" : "‚¨ú"}</li>
                            <li>Battery Demo: ${w.p4_c2 === "true" ? "‚úÖ" : "‚¨ú"}</li>
                            <li>Surge Calc: ${w.p4_c3 === "true" ? "‚úÖ" : "‚¨ú"}</li>
                            <li>Grant Prop: ${w.p4_c4 === "true" ? "‚úÖ" : "‚¨ú"}</li>
                            <li>Network Map: ${w.p4_c5 === "true" ? "‚úÖ" : "‚¨ú"}</li>
                        </ul>`;
                    } else {
                        content = `<p>Raw Data for ${phase}:</p><pre>${JSON.stringify(w, null, 2)}</pre>`;
                    }

                    document.getElementById('td-title').innerText = `MISSION LOG: ${teamName}`;
                    document.getElementById('td-content').innerHTML = content;
                    document.getElementById('team-details-modal').classList.remove('hidden');
                }
            },

            tab: function(id) {
                document.querySelectorAll('.plan-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.plan-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('tab-'+id).classList.add('active');
                event.target.classList.add('active');
            },

            // --- AUTH ---
            openStudentAuth: function() { document.getElementById('st-auth-modal').classList.remove('hidden'); },
            openAuthModal: function() { document.getElementById('tr-auth-modal').classList.remove('hidden'); },
            closeAuth: function() { this.hideViews(); document.getElementById('landing-view').classList.remove('hidden'); },
            stAuthMode: function(mode) {
                document.getElementById('st-login-f').classList.toggle('hidden', mode === 'reg');
                document.getElementById('st-reg-f').classList.toggle('hidden', mode === 'login');
            },
            
            // STUDENT REGISTRATION (Create Doc)
            regStudent: async function() {
                const t = document.getElementById('r-team').value;
                const m = document.getElementById('r-mems').value;
                const p = document.getElementById('r-pass').value;
                if(!t || !m || !p) return alert("Fields required");
                
                try {
                    await setDoc(doc(db, "teams", t), {
                        team: t, mems: m, password: p, lastPhase: 'mission', worksheets: {}
                    });
                    this.enterStudent(t);
                } catch (e) { alert("Error creating team. Name might be taken."); }
            },

            // STUDENT LOGIN (Read Doc)
            loginStudent: async function() {
                const t = document.getElementById('l-team').value;
                const p = document.getElementById('l-pass').value;
                
                const docRef = doc(db, "teams", t);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().password === p) {
                    this.enterStudent(t);
                } else {
                    alert("Access Denied. Check Team Name or Password.");
                }
            },

            enterStudent: function(team) {
                this.state = {team, role:'st'};
                localStorage.setItem('j_session_cloud', JSON.stringify(this.state));
                this.hideViews();
                document.getElementById('st-team-tag').innerText = team.toUpperCase();
                document.getElementById('student-dashboard').classList.remove('hidden');
                this.studentRoute('mission');
            },

            verifyTeacher: function() {
                if(document.getElementById('tr-pass').value === ADMIN_KEY) this.enterTeacher();
                else alert("Invalid Key");
            },

            enterTeacher: function() {
                this.state = {role:'tr'};
                localStorage.setItem('j_session_cloud', JSON.stringify(this.state));
                this.hideViews();
                document.getElementById('teacher-dashboard').classList.remove('hidden');
                this.teacherRoute('ops');
            },

            logout: function() {
                localStorage.removeItem('j_session_cloud');
                location.reload();
            }
        };
    </script>
</body>
</html>
