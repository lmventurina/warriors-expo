<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Jóhonaaʼéí Portal V2</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            getFirestore, 
            doc, 
            setDoc, 
            updateDoc, 
            onSnapshot, 
            collection 
        };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. GLOBAL SETUP & HOOKS ---
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const useFirebase = () => {
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [appId, setAppId] = useState(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                const init = async () => {
                    try {
                        let attempts = 0;
                        while (!window.firebaseModules && attempts < 50) {
                            await new Promise(r => setTimeout(r, 100));
                            attempts++;
                        }
                        if (!window.firebaseModules) throw new Error("Failed to load Firebase libraries.");

                        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebaseModules;
                        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        
                        setAppId(currentAppId);
                        setDb(firestore);

                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }

                        onAuthStateChanged(auth, (u) => setUser(u));
                    } catch (err) {
                        console.error("Firebase Init Error:", err);
                        setError(err.message);
                    }
                };
                init();
            }, []);

            return { db, user, appId, error };
        };

        // --- 2. ASSETS & CONSTANTS ---
        const ICONS = {
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            User: <g><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></g>,
            Eye: <g><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></g>,
            FileText: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" /></g>,
            Save: <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></g>,
            CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></g>,
            Calculator: <g><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></g>,
            Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.09a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.09a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></g>,
            ChevronLeft: <path d="m15 18-6-6 6-6" />,
            ChevronRight: <path d="m9 18 6-6-6-6" />,
            ChevronUp: <path d="m18 15-6-6-6 6" />,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            List: <g><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></g>,
            Calendar: <g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></g>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />,
            BookOpen: <g><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></g>,
            ExternalLink: <g><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" x2="21" y1="14" y2="3" /></g>,
            Presentation: <g><rect width="20" height="14" x="2" y="3" rx="2" /><line x1="8" x2="16" y1="21" y2="21" /><line x1="12" x2="12" y1="17" y2="21" /></g>,
            X: <path d="M18 6 6 18M6 6l12 12" />,
            Beaker: <path d="M4.5 3h15M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3M6 14h12" />,
            Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
            Lock: <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />,
            Info: <g><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="16" y2="12" /><line x1="12" x2="12.01" y1="8" y2="8" /></g>,
            Users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></g>
        };

        const LucideIcon = React.memo(({ name, size = 20, className }) => {
            if (!ICONS[name]) return <span className="text-red-500">?</span>;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {ICONS[name]}
                </svg>
            );
        });

        // --- GLOSSARY & TOOLTIPS ---
        const GLOSSARY = {
            "Galvanic Cell": "A device that generates electricity through a chemical reaction (like a battery).",
            "Inverter": "A device that changes solar power (DC) into the power used by homes (AC).",
            "IoT": "Internet of Things: Everyday objects connected to the internet.",
            "Attack Surface": "The total number of points where an unauthorized user can try to enter a system.",
            "Thermal Runaway": "A chain reaction where a battery gets hotter and hotter, potentially causing a fire.",
            "Kilowatt-hours": "A unit of energy. Running a 1000-watt microwave for 1 hour uses 1 kWh.",
            "Sovereignty": "The authority of a state to govern itself. Energy Sovereignty means owning your own power.",
            "Encryption": "Scrambling data using a secret code so only authorized people can read it.",
            "Packet Sniffer": "A tool used to intercept and read data packets traveling across a network.",
            "Firewall": "A security system that blocks unauthorized access to or from a private network.",
            "Redox": "Chemical reaction involving transfer of electrons.",
            "Load": "The amount of power being drawn from the electrical grid.",
            "Vanadium": "A metal used in large flow batteries that is safer than Lithium.",
            "Smart Meter": "A digital meter that records energy usage and sends it wirelesssly."
        };

        const ROLES_GLOSSARY = {
            "Project Lead": "Coordinate team tasks, ensure deadlines are met, and lead the final presentation.",
            "Historian": "Research historical context, treaty rights, and social impact of energy decisions.",
            "Cyber Analyst": "Identify network vulnerabilities, secure data flow, and analyze cyber threats.",
            "Energy Scientist": "Calculate energy loads, design battery systems, and understand chemical storage.",
            "Comms Officer": "Draft reports, translate technical jargon, and manage public messaging."
        };

        const TermTooltip = React.memo(({ term, definition }) => {
            const [visible, setVisible] = useState(false);
            return (
                <span className="relative inline-block border-b-2 border-dashed border-sky-500 cursor-help group" onMouseEnter={() => setVisible(true)} onMouseLeave={() => setVisible(false)}>
                    <span className="text-sky-300 font-medium">{term}</span>
                    {visible && (
                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 p-3 bg-slate-900 border border-sky-500 rounded-lg shadow-2xl z-50 text-xs text-white pointer-events-none animate-in fade-in zoom-in-95 duration-200">
                            <div className="font-bold text-sky-400 mb-1 uppercase tracking-wider">{term}</div>{definition}
                            <div className="absolute top-full left-1/2 -translate-x-1/2 border-8 border-transparent border-t-sky-500"></div>
                        </div>
                    )}
                </span>
            );
        });

        const RoleTooltip = React.memo(({ role }) => {
            const [visible, setVisible] = useState(false);
            const [coords, setCoords] = useState({ top: 0, left: 0 });
            const triggerRef = useRef(null);
            const definition = ROLES_GLOSSARY[role] || "Team member role.";

            const showTooltip = () => {
                if (triggerRef.current) {
                    const rect = triggerRef.current.getBoundingClientRect();
                    setCoords({ top: rect.top, left: rect.right + 10 });
                    setVisible(true);
                }
            };

            return (
                 <>
                    <div ref={triggerRef} className="inline-block cursor-help border-b border-dashed border-sky-500/50 mb-0.5" onMouseEnter={showTooltip} onMouseLeave={() => setVisible(false)}>
                        <span className="text-[10px] text-sky-500 font-mono uppercase tracking-wider">{role}</span>
                    </div>
                    {visible && ReactDOM.createPortal(
                        <div className="fixed w-56 p-3 bg-slate-900 border border-sky-500 rounded-lg shadow-2xl z-[9999] text-xs text-stone-200 pointer-events-none animate-in fade-in zoom-in-95 duration-200" style={{ top: coords.top, left: coords.left, transform: 'translateY(-10%)' }}>
                            <div className="font-bold text-sky-400 mb-1">{role}</div>{definition}
                        </div>,
                        document.body
                    )}
                </>
            );
        });

        const GlossaryText = React.memo(({ text }) => {
            if (!text) return null;
            const terms = Object.keys(GLOSSARY);
            const regex = new RegExp(`\\b(${terms.join('|')})\\b`, 'gi');
            const parts = text.split(regex);
            return (
                <span>
                    {parts.map((part, i) => {
                        const matchedKey = terms.find(t => t.toLowerCase() === part.toLowerCase());
                        return matchedKey ? <TermTooltip key={i} term={part} definition={GLOSSARY[matchedKey]} /> : part;
                    })}
                </span>
            );
        });

        const TabInstructions = React.memo(({ tab }) => {
            const instructions = {
                mission: "Welcome to Mission Control. Here you track your squad's progress. Check off tasks as you complete them to unlock the next phases of the operation.",
                timeline: "This is the master schedule. Click on any phase node to expand it and see the detailed breakdown of activities and intel for that week.",
                worksheets: "These are your official logs. Select a document from the list, fill in your data and findings, and submit them to Command for review.",
                labs: "Welcome to the Simulation Lab. Select a module (Battery, Network, or Crypto) to run virtual experiments. Use the data you gather here for your reports.",
                tools: "Field Utilities. Use the Load Balancer to calculate power requirements and ensure grid stability."
            };
            if (!instructions[tab]) return null;
            return (
                <div className="bg-sky-900/20 border border-sky-500/30 p-4 rounded-lg mb-6 flex items-start gap-3 animate-in fade-in slide-in-from-top-2">
                    <div className="bg-sky-500/20 p-2 rounded-full shrink-0"><LucideIcon name="Info" className="text-sky-400" size={20} /></div>
                    <div><h4 className="text-sky-400 font-bold text-sm uppercase tracking-wider mb-1">Directive</h4><p className="text-sm text-sky-100 leading-relaxed">{instructions[tab]}</p></div>
                </div>
            );
        });

        // --- DATA CONSTANTS ---
        const PHASES = [
            { id: 1, title: "Phase 1: Foundation", duration: "Weeks 1-2", weekRange: [1, 2], intel: "We are transitioning to Solar. Map the network and understand battery chemistry.", tasks: [{ id: "p1_t1", text: "History: Compare 'Era of Coal' vs 'Era of Sun'", role: "Historian", worksheetId: "history_tchart", description: "Research the economic impact of NGS vs Kayenta Solar." }, { id: "p1_t2", text: "Cyber: Map IoT Ecosystem & Vulnerabilities", role: "Analyst", worksheetId: "cyber_map", description: "Draw a diagram connecting the Solar Panel -> Inverter -> Cloud." }, { id: "p1_t3", text: "Chem: Galvanic Cell Challenge", role: "Scientist", worksheetId: "chem_lab", description: "Build a battery using lemons or saltwater." }, { id: "p1_t4", text: "Math: Calculate Home kWh Usage", role: "Scientist", description: "Calculate total kWh a standard Navajo home uses." }] },
            { id: 2, title: "Phase 2: The Attack", duration: "Weeks 3-4", weekRange: [3, 4], intel: "ALERT: Man-in-the-Middle attack confirmed. Spoofed signals detected.", tasks: [{ id: "p2_t1", text: "Cyber: Sniff the Wire", role: "Analyst", description: "Use the Packet Sniffer to find the anomalous data packet." }, { id: "p2_t2", text: "Chem: Thermal Runaway Sim", role: "Scientist", description: "Simulate battery overcharge." }, { id: "p2_t3", text: "Math: Blackout Calculus (P=IV)", role: "Scientist", worksheetId: "math_calc", description: "Use P=IV to prove hacker's load data causes overload." }, { id: "p2_t4", text: "ELA: Write Incident Report", role: "Communicator", worksheetId: "ela_report", description: "Draft a formal report of the cyber attack." }] },
            { id: 3, title: "Phase 3: Defense", duration: "Weeks 5-6", weekRange: [5, 6], intel: "Harden the network. Encrypt traffic and propose safer batteries.", tasks: [{ id: "p3_t1", text: "Cyber: Defense in Depth", role: "Analyst", description: "Re-configure network to use HTTPS." }, { id: "p3_t2", text: "ELA: Grant Proposal Writing", role: "Communicator", description: "Write a proposal to Dept of Energy for upgrades." }, { id: "p3_t3", text: "History: Data Sovereignty", role: "Historian", description: "Create a timeline of Navajo Sovereignty." }, { id: "p3_t4", text: "Chem: Vanadium Recommendation", role: "Scientist", description: "Research Vanadium Redox Flow batteries." }] },
            { id: 4, title: "Phase 4: Expo", duration: "Weeks 7-8", weekRange: [7, 8], intel: "Operation K'é. Present your SOC to the elders.", tasks: [{ id: "p4_t1", text: "Build: Assemble SOC Booth", role: "All", description: "Construct the Tri-Fold board." }, { id: "p4_t2", text: "ELA: Elevator Pitch Practice", role: "Communicator", description: "Write and memorize a 2-minute speech." }, { id: "p4_t3", text: "Team: Audience Adaptation", role: "All", description: "Rehearse presentation for elders." }, { id: "p4_t4", text: "Demo: Final System Test", role: "Scientist", description: "Perform final dry-run of battery demo." }] }
        ];

        const LESSON_PLANS = {
            1: { title: "Phase 1: Foundation", subjects: [{ subject: "History", topic: "The Era of Coal vs. Sun", alignment: "NM-H.9-12.2", days: [{ day: "Day 1", title: "Project Kickoff", detail: "Discuss NGS closure.", materials: ["Projector"], presentation: { title: "Coal vs Solar", slides: [{ title: "Today's Mission", content: ["Explain shift to Solar."] }, { title: "NGS", content: ["2250 MW Capacity"], image: "https://placehold.co/800x450/334155/FFFFFF?text=NGS+Plant" }, { title: "Activity", content: ["Discuss impact."] }] } }, { day: "Day 2", title: "Comparative Analysis", detail: "T-Chart activity.", worksheetId: "history_tchart" }, { day: "Day 3", title: "Sovereignty Intro", detail: "Define Energy Sovereignty.", presentation: { title: "Sovereignty", slides: [{ title: "Definition", content: ["Right to govern."] }] } }] }, { subject: "Cybersecurity", topic: "IoT & Attack Surfaces", alignment: "CSTA 3A-NI-04", days: [{ day: "Day 4", title: "Network Basics", detail: "Lecture on IoT.", presentation: { title: "IoT Basics", slides: [{ title: "What is IoT?", content: ["Internet of Things"], image: "https://placehold.co/800x450/334155/FFFFFF?text=IoT+Diagram" }] } }, { day: "Day 5", title: "Threat Modeling", detail: "Cyber Map activity.", worksheetId: "cyber_map" }] }, { subject: "Chemistry", topic: "Battery Chemistry", alignment: "HS-PS1-7", days: [{ day: "Day 6", title: "Galvanic Cells", detail: "Lemon battery lab.", worksheetId: "chem_lab", presentation: { title: "Galvanic Cells", slides: [{ title: "Anatomy", content: ["Anode, Cathode"], image: "https://placehold.co/800x450/334155/FFFFFF?text=Galvanic+Cell" }] } }, { day: "Day 7", title: "Series vs Parallel", detail: " connecting cells." }] }, { subject: "Math", topic: "Energy Quantities", alignment: "HSN.Q.A.1", days: [{ day: "Day 8", title: "Home Audit", detail: "Calculate kWh.", presentation: { title: "Kilowatts", slides: [{ title: "Power vs Energy", content: ["kW vs kWh"] }] } }, { day: "Day 9", title: "Solar Sizing", detail: "Array calculation." }] }] },
            2: { title: "Phase 2: The Attack", subjects: [{ subject: "Math", topic: "Power Law (P=IV)", alignment: "HSA.CED.A.4", days: [{ day: "Day 5", title: "Grid Load", detail: "Blackout Calculus.", worksheetId: "math_calc", presentation: { title: "Blackout Formula", slides: [{ title: "P=IV", content: ["Power Law"], image: "https://placehold.co/800x450/334155/FFFFFF?text=Grid+Load" }] } }, { day: "Day 6", title: "Failure Point", detail: "Calc failure amps." }] }, { subject: "Cybersecurity", topic: "Packet Sniffing", alignment: "CSTA 3A-NI-05", days: [{ day: "Day 1", title: "Handshake", detail: "Simulate Wi-Fi.", presentation: { title: "Packet Sniffing", slides: [{ title: "Packets", content: ["Data chunks"] }] } }, { day: "Day 2", title: "Inspection", detail: "Wireshark sim." }] }] },
            3: { title: "Phase 3: Defense", subjects: [{ subject: "Cybersecurity", topic: "Encryption", alignment: "CSTA 3A-NI-06", days: [{ day: "Day 1", title: "Encryption 101", detail: "Caesar Ciphers.", presentation: { title: "Encryption", slides: [{ title: "Ciphertext", content: ["Scrambled data"], image: "https://placehold.co/800x450/334155/FFFFFF?text=Encryption" }] } }] }] },
            4: { title: "Phase 4: Expo", subjects: [{ subject: "Engineering", topic: "Integration", alignment: "HS-ETS1-3", days: [{ day: "Day 1", title: "Booth Build", detail: "Construct booth.", presentation: { title: "Integration", slides: [{ title: "Layout", content: ["Flow"], image: "https://placehold.co/800x450/334155/FFFFFF?text=Booth+Layout" }] } }] }] }
        };

        const WORKSHEETS = {
            history_tchart: { title: "History: Coal vs. Solar T-Chart", fields: [{ id: "coal_jobs", label: "Coal Jobs", type: "textarea" }, { id: "solar_jobs", label: "Solar Jobs", type: "textarea" }, { id: "analysis", label: "Analysis", type: "textarea" }] },
            cyber_map: { title: "Cyber: IoT Network Map", fields: [{ id: "topology", label: "Topology", type: "textarea" }, { id: "risk_a", label: "Risk A", type: "text" }] },
            chem_lab: { title: "Chemistry: Galvanic Cell Log", fields: [{ id: "anode", label: "Anode", type: "text" }, { id: "voltage", label: "Voltage", type: "number" }] },
            math_calc: { title: "Math: Blackout Calculus", fields: [{ id: "load", label: "Total Load", type: "number" }, { id: "result", label: "Result", type: "text" }] },
            ela_report: { title: "ELA: Incident Report", fields: [{ id: "desc", label: "Description", type: "textarea" }] }
        };

        // --- SIMULATION COMPONENTS ---
        const BatterySim = () => {
            const [anode, setAnode] = useState('zinc');
            const [cathode, setCathode] = useState('copper');
            const potentials = { zinc: -0.76, magnesium: -2.37, copper: 0.34, silver: 0.80, iron: -0.44 };
            const voltage = (potentials[cathode] - potentials[anode]).toFixed(2);
            return (
                <div className="h-full flex flex-col items-center justify-center space-y-8 p-4">
                    <div className="text-center"><h2 className="text-2xl font-bold text-white mb-2">Virtual Galvanic Cell</h2><p className="text-stone-400 text-sm">Select metals to build your battery.</p></div>
                    <div className="flex gap-8 items-end">
                        <div className="flex flex-col gap-2 items-center"><label className="text-xs font-bold text-stone-500 uppercase">Anode (-)</label><select value={anode} onChange={(e) => setAnode(e.target.value)} className="bg-stone-900 border border-stone-600 rounded p-2 text-white"><option value="zinc">Zinc</option><option value="magnesium">Magnesium</option></select><div className="w-24 h-32 bg-stone-700 border-2 border-stone-500 rounded relative"><div className="absolute inset-0 bg-yellow-500/20 flex items-center justify-center text-xs text-yellow-200">Electrolyte</div></div></div>
                        <div className="flex flex-col items-center gap-2 mb-10"><div className="text-4xl font-mono font-bold text-emerald-400 bg-black px-4 py-2 rounded border border-stone-700">{voltage} V</div></div>
                        <div className="flex flex-col gap-2 items-center"><label className="text-xs font-bold text-stone-500 uppercase">Cathode (+)</label><select value={cathode} onChange={(e) => setCathode(e.target.value)} className="bg-stone-900 border border-stone-600 rounded p-2 text-white"><option value="copper">Copper</option><option value="silver">Silver</option></select><div className="w-24 h-32 bg-stone-700 border-2 border-stone-500 rounded relative"><div className="absolute inset-0 bg-yellow-500/20 flex items-center justify-center text-xs text-yellow-200">Electrolyte</div></div></div>
                    </div>
                </div>
            );
        };

        const PacketSim = () => {
            const [packets, setPackets] = useState([]);
            const [score, setScore] = useState(0);
            const [running, setRunning] = useState(false);
            useEffect(() => {
                let interval;
                if (running) {
                    interval = setInterval(() => {
                        const isBad = Math.random() < 0.3;
                        const newPacket = { id: Date.now(), hex: "A1 B2 C3", bad: isBad, voltage: isBad ? "14.5" : "12.4" };
                        setPackets(prev => [newPacket, ...prev].slice(0, 8));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [running]);
            return (
                <div className="h-full flex flex-col p-4">
                    <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-white">Packet Sniffer</h2><button onClick={() => setRunning(!running)} className="px-4 py-2 bg-emerald-600 rounded text-white text-xs">{running ? 'STOP' : 'START'}</button></div>
                    <div className="flex-1 bg-black rounded border border-stone-700 p-4 font-mono text-xs overflow-hidden relative">
                        {packets.map(pkt => <div key={pkt.id} className={`p-2 border-l-2 mb-1 ${pkt.bad ? 'border-red-500 text-red-400' : 'border-emerald-500 text-stone-400'}`}>DATA: {pkt.hex} | V: {pkt.voltage}V</div>)}
                    </div>
                </div>
            );
        };

        const CryptoSim = () => {
            const [input, setInput] = useState('ENERGY');
            const [shift, setShift] = useState(3);
            const encrypt = (str, s) => str.toUpperCase().replace(/[A-Z]/g, c => String.fromCharCode(((c.charCodeAt(0)-65+s)%26)+65));
            return (
                <div className="h-full flex flex-col p-4 items-center justify-center">
                    <h2 className="text-xl font-bold text-white mb-6">Caesar Cipher</h2>
                    <input value={input} onChange={e => setInput(e.target.value)} className="bg-stone-900 border border-stone-600 rounded p-2 text-white mb-4" />
                    <input type="range" min="1" max="25" value={shift} onChange={e => setShift(parseInt(e.target.value))} className="w-full accent-orange-500 mb-4" />
                    <div className="text-2xl font-mono text-emerald-400">{encrypt(input, shift)}</div>
                </div>
            );
        };

        const LabSimulations = () => {
            const [sim, setSim] = useState('battery');
            return (
                <div className="h-full flex flex-col">
                    <div className="flex gap-2 bg-stone-900/50 p-2 rounded mb-4">
                        <button onClick={() => setSim('battery')} className="text-xs text-white px-3 py-1 bg-stone-700 rounded">Battery</button>
                        <button onClick={() => setSim('network')} className="text-xs text-white px-3 py-1 bg-stone-700 rounded">Network</button>
                        <button onClick={() => setSim('crypto')} className="text-xs text-white px-3 py-1 bg-stone-700 rounded">Crypto</button>
                    </div>
                    <div className="flex-1 bg-stone-800 rounded border border-stone-700 overflow-hidden">
                        {sim === 'battery' && <BatterySim />}
                        {sim === 'network' && <PacketSim />}
                        {sim === 'crypto' && <CryptoSim />}
                    </div>
                </div>
            )
        };

        // --- COMPONENTS ---
        const PresentationModal = ({ presentation, onClose }) => {
            const [currentSlide, setCurrentSlide] = useState(0);
            if (!presentation || !presentation.slides) return null;
            const slides = presentation.slides;
            return (
                <div className="fixed inset-0 bg-black z-[100] flex flex-col text-white">
                    <div className="p-4 bg-stone-900 border-b border-stone-700 flex justify-between items-center">
                        <h2 className="font-bold text-lg text-orange-500">{presentation.title}</h2><button onClick={onClose}><LucideIcon name="X" /></button>
                    </div>
                    <div className="flex-1 flex items-center justify-center p-8 bg-stone-950">
                        <div className="w-full max-w-6xl aspect-video bg-white text-black rounded-lg shadow-2xl p-12 flex flex-col relative overflow-hidden">
                            <h1 className="text-4xl font-bold mb-8 text-orange-600">{slides[currentSlide].title}</h1>
                            <ul className="space-y-4 text-2xl pl-8">{slides[currentSlide].content.map((point, i) => <li key={i} className="list-disc pl-2">{point}</li>)}</ul>
                            {slides[currentSlide].image && <img src={slides[currentSlide].image} className="absolute bottom-4 right-4 w-64 h-auto rounded border" />}
                        </div>
                    </div>
                    <div className="p-6 bg-stone-900 flex justify-center gap-4">
                        <button onClick={() => setCurrentSlide(c => Math.max(0, c - 1))} className="text-white">Prev</button>
                        <button onClick={() => setCurrentSlide(c => Math.min(slides.length - 1, c + 1))} className="text-white">Next</button>
                    </div>
                </div>
            );
        };

        const TimelineDisplay = React.memo(({ currentWeek, compact = false, orientation = 'vertical' }) => {
            const [expandedItems, setExpandedItems] = useState({});
            
            useEffect(() => {
                const activePhase = PHASES.find(p => currentWeek >= p.weekRange[0] && currentWeek <= p.weekRange[1]);
                if (activePhase) setExpandedItems({ [activePhase.id]: true });
            }, [currentWeek]);

            const togglePhase = useCallback((id) => {
                setExpandedItems(prev => (prev[id] ? {} : { [id]: true }));
            }, []);

            if (orientation === 'horizontal') {
                return (
                    <div className="w-full">
                        <div className="flex justify-between items-start relative px-8 pb-4">
                            <div className="absolute top-2 left-8 right-8 h-0.5 bg-slate-700 z-0"></div>
                            {PHASES.map((phase) => {
                                const isActive = currentWeek >= phase.weekRange[0] && currentWeek <= phase.weekRange[1];
                                return (
                                    <div key={phase.id} className="relative z-10 flex flex-col items-center flex-1">
                                        <button onClick={() => togglePhase(phase.id)} className={`w-4 h-4 rounded-full mb-2 ${isActive ? 'bg-sky-400' : 'bg-slate-600'}`}></button>
                                        <div className="text-center text-white text-xs">{phase.title}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            return (
                <div className="relative border-l border-slate-700 ml-3 py-4 space-y-12">
                    {PHASES.map(phase => (
                        <div key={phase.id} className="pl-8 relative">
                            <button onClick={() => togglePhase(phase.id)} className="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-slate-600"></button>
                            <div className="text-white font-bold cursor-pointer" onClick={() => togglePhase(phase.id)}>{phase.title}</div>
                            {expandedItems[phase.id] && <div className="mt-2 text-sm text-slate-400"><GlossaryText text={phase.intel} /></div>}
                        </div>
                    ))}
                </div>
            );
        });

        const WorksheetForm = ({ worksheetId, data, onSave, readOnly = false, onClose }) => {
            const schema = WORKSHEETS[worksheetId];
            const [formData, setFormData] = useState(data || {});

            useEffect(() => { setFormData(data || {}); }, [data, worksheetId]);

            const handleChange = useCallback((fieldId, value) => {
                if (readOnly) return;
                setFormData(prev => ({ ...prev, [fieldId]: value }));
            }, [readOnly]);

            if (!schema) return <div>Select a worksheet</div>;

            return (
                <div className="bg-slate-800 p-6 rounded-lg border border-slate-700">
                    <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><LucideIcon name="FileText" /> {schema.title}</h3>
                    <div className="space-y-4">
                        {schema.fields.map(field => (
                            <div key={field.id}>
                                <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">{field.label}</label>
                                <textarea className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-white" value={formData[field.id] || ''} onChange={(e) => handleChange(field.id, e.target.value)} readOnly={readOnly} />
                            </div>
                        ))}
                    </div>
                    {!readOnly && <button onClick={() => onSave(worksheetId, formData)} className="mt-6 w-full bg-emerald-600 text-white font-bold py-3 rounded">Submit</button>}
                    {readOnly && <button onClick={onClose} className="mt-6 w-full bg-slate-700 text-white font-bold py-3 rounded">Close</button>}
                </div>
            );
        };

        const StudentView = ({ db, user, appId, globalSettings, onLogout }) => {
            const [teamName, setTeamName] = useState('');
            const [teamMembers, setTeamMembers] = useState([{ role: 'Project Lead', name: '' }]);
            const [tasks, setTasks] = useState([]);
            const [worksheetsData, setWorksheetsData] = useState({});
            const [activeTab, setActiveTab] = useState('mission');
            const [activeWorksheet, setActiveWorksheet] = useState(null);
            
            const { doc, setDoc, onSnapshot } = window.firebaseModules;

            useEffect(() => {
                if (!db || !user) return;
                const teamDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', user.uid);
                const unsub = onSnapshot(teamDocRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setTeamName(d.name || '');
                        setTasks(d.tasks || []);
                        setWorksheetsData(d.worksheets || {});
                    }
                });
                return () => unsub();
            }, [db, user]);

            const saveTeamInfo = useCallback(async () => {
                const teamDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', user.uid);
                await setDoc(teamDocRef, { name: teamName, members: teamMembers }, { merge: true });
            }, [db, user, teamName, teamMembers]);

            const toggleTask = useCallback(async (taskId) => {
                const newTasks = tasks.includes(taskId) ? tasks.filter(t => t !== taskId) : [...tasks, taskId];
                const teamDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', user.uid);
                await setDoc(teamDocRef, { tasks: newTasks }, { merge: true });
            }, [db, user, tasks]);

            const saveWorksheet = useCallback(async (id, data) => {
                const teamDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'teams', user.uid);
                await setDoc(teamDocRef, { worksheets: { ...worksheetsData, [id]: data } }, { merge: true });
                alert("Saved!");
                setActiveWorksheet(null);
            }, [db, user, worksheetsData]);

            return (
                <div className="flex flex-col h-screen">
                    <header className="bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center"><div className="text-white font-bold">NTUA.SEC</div><button onClick={onLogout} className="text-xs text-slate-500">Disconnect</button></header>
                    <div className="flex flex-1 overflow-hidden">
                        <aside className="w-64 bg-slate-900/50 border-r border-slate-800 p-4 flex flex-col gap-2">
                            <input value={teamName} onChange={e => setTeamName(e.target.value)} onBlur={saveTeamInfo} placeholder="Team Name" className="bg-slate-800 text-white p-2 rounded mb-4" />
                            <button onClick={() => setActiveTab('mission')} className="text-slate-400 hover:text-white text-left">Mission</button>
                            <button onClick={() => setActiveTab('timeline')} className="text-slate-400 hover:text-white text-left">Timeline</button>
                            <button onClick={() => setActiveTab('worksheets')} className="text-slate-400 hover:text-white text-left">Worksheets</button>
                            <button onClick={() => setActiveTab('labs')} className="text-slate-400 hover:text-white text-left">Labs</button>
                        </aside>
                        <main className="flex-1 overflow-y-auto p-6 bg-slate-900/30">
                            <TabInstructions tab={activeTab} />
                            {activeTab === 'mission' && (
                                <div className="space-y-6">
                                    {PHASES.map(phase => (
                                        <div key={phase.id} className="bg-slate-800 rounded p-4">
                                            <h3 className="text-white font-bold">{phase.title}</h3>
                                            {phase.tasks.map(t => (
                                                <div key={t.id} className="flex items-center gap-2 mt-2">
                                                    <input type="checkbox" checked={tasks.includes(t.id)} onChange={() => toggleTask(t.id)} />
                                                    <span className="text-slate-300 text-sm"><GlossaryText text={t.text} /></span>
                                                    {t.worksheetId && <button onClick={() => { setActiveTab('worksheets'); setActiveWorksheet(t.worksheetId); }} className="text-xs bg-sky-900 text-sky-300 px-2 rounded">Open</button>}
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            )}
                            {activeTab === 'timeline' && <TimelineDisplay currentWeek={globalSettings.currentWeek} />}
                            {activeTab === 'worksheets' && (
                                <div>
                                    {!activeWorksheet && Object.keys(WORKSHEETS).map(k => (
                                        <button key={k} onClick={() => setActiveWorksheet(k)} className="block w-full text-left p-3 bg-slate-800 border border-slate-700 text-white mb-2 rounded">{WORKSHEETS[k].title}</button>
                                    ))}
                                    {activeWorksheet && <WorksheetForm worksheetId={activeWorksheet} data={worksheetsData[activeWorksheet]} onSave={saveWorksheet} />}
                                </div>
                            )}
                            {activeTab === 'labs' && <LabSimulations />}
                        </main>
                    </div>
                </div>
            );
        };

        const TeacherView = ({ db, appId, globalSettings, onLogout }) => {
            const [teams, setTeams] = useState([]);
            const [view, setView] = useState('dashboard');
            const [previewDoc, setPreviewDoc] = useState(null);
            const [activeDeck, setActiveDeck] = useState(null);
            const [selectedLessonPhase, setSelectedLessonPhase] = useState(1);
            
            const { collection, onSnapshot, doc, setDoc } = window.firebaseModules;

            useEffect(() => {
                if (!db) return;
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'teams'), (snap) => {
                    setTeams(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, [db]);

            const updateCurrentWeek = useCallback(async (newWeek) => {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { currentWeek: newWeek }, { merge: true });
            }, [db]);

            return (
                <div className="flex flex-col h-screen bg-stone-900 text-stone-200">
                    <header className="p-4 bg-stone-900 border-b border-stone-800 flex justify-between">
                        <h1 className="font-bold text-white">COMMAND CENTER</h1>
                        <div className="flex gap-4">
                            <button onClick={() => setView('dashboard')} className="text-stone-400 hover:text-white">Dashboard</button>
                            <button onClick={() => setView('lessons')} className="text-stone-400 hover:text-white">Lessons</button>
                            <button onClick={() => setView('mission')} className="text-stone-400 hover:text-white">Mission</button>
                            <button onClick={onLogout} className="text-stone-500">Exit</button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden flex relative">
                         {previewDoc && (
                            <div className="absolute inset-0 bg-stone-900/90 z-50 flex items-center justify-center p-8">
                                <div className="w-full max-w-4xl bg-slate-800 border border-slate-700 rounded-xl shadow-2xl p-6 relative">
                                    <button onClick={() => setPreviewDoc(null)} className="absolute top-4 right-4 text-white">Close</button>
                                    <WorksheetForm worksheetId={previewDoc} data={{}} readOnly={true} />
                                </div>
                            </div>
                        )}
                        {activeDeck && <PresentationModal presentation={activeDeck} onClose={() => setActiveDeck(null)} />}
                        
                        {view === 'dashboard' && (
                            <div className="p-8 w-full">
                                <div className="bg-stone-800 rounded p-4">
                                    <h3 className="text-white font-bold mb-4">Teams</h3>
                                    {teams.map(t => (
                                        <div key={t.id} className="p-2 border-b border-stone-700 flex justify-between">
                                            <span>{t.name || 'Unnamed'}</span>
                                            <span>Progress: {t.tasks ? t.tasks.length : 0}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {view === 'lessons' && (
                            <div className="p-8 flex gap-8 w-full">
                                <div className="w-64 bg-stone-800 rounded h-full">
                                    {Object.keys(LESSON_PLANS).map(id => (
                                        <button key={id} onClick={() => setSelectedLessonPhase(id)} className="block w-full text-left p-4 border-b border-stone-700 text-stone-400 hover:text-white">
                                            {LESSON_PLANS[id].title}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex-1 bg-stone-800 rounded p-8 overflow-y-auto">
                                    <h2 className="text-2xl font-bold text-white mb-6">{LESSON_PLANS[selectedLessonPhase].title}</h2>
                                    {LESSON_PLANS[selectedLessonPhase].subjects.map((subj, i) => (
                                        <div key={i} className="mb-8">
                                            <h3 className="text-xl text-orange-400 font-bold">{subj.subject}</h3>
                                            {subj.days.map((day, j) => (
                                                <div key={j} className="bg-stone-900 p-4 rounded mt-2">
                                                    <div className="flex justify-between">
                                                        <span className="text-white font-bold">{day.day}: {day.title}</span>
                                                        <div className="flex gap-2">
                                                            {day.worksheetId && <button onClick={() => setPreviewDoc(day.worksheetId)} className="text-xs bg-sky-900 px-2 py-1 rounded text-sky-200">Preview Doc</button>}
                                                            {day.presentation && <button onClick={() => setActiveDeck(day.presentation)} className="text-xs bg-orange-700 px-2 py-1 rounded text-white">Launch Deck</button>}
                                                        </div>
                                                    </div>
                                                    <p className="text-stone-400 text-sm mt-1">{day.detail}</p>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {view === 'mission' && (
                            <div className="p-8 w-full">
                                <div className="bg-stone-800 p-6 rounded mb-8">
                                    <h3 className="text-white font-bold mb-4">Global Controls</h3>
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => updateCurrentWeek(Math.max(1, globalSettings.currentWeek - 1))} className="text-white bg-stone-700 px-3 py-1 rounded">-</button>
                                        <span className="text-2xl text-white font-bold">Week {globalSettings.currentWeek}</span>
                                        <button onClick={() => updateCurrentWeek(Math.min(8, globalSettings.currentWeek + 1))} className="text-white bg-stone-700 px-3 py-1 rounded">+</button>
                                    </div>
                                </div>
                                <div className="bg-stone-800 p-6 rounded">
                                    <h3 className="text-stone-400 font-bold mb-4">Timeline Preview</h3>
                                    <TimelineDisplay currentWeek={globalSettings.currentWeek} />
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const LandingPage = ({ globalSettings, onSelectRole }) => {
            return (
                <div className="h-screen bg-slate-950 flex flex-col">
                    <div className="bg-slate-900 p-6 border-b border-slate-800">
                        <TimelineDisplay currentWeek={globalSettings.currentWeek} orientation="horizontal" />
                    </div>
                    <div className="flex-1 flex items-center justify-center">
                        <div className="bg-slate-900 p-8 rounded-xl border border-slate-800 shadow-2xl text-center">
                            <h1 className="text-3xl font-bold text-white mb-8">Project Jóhonaaʼéí</h1>
                            <div className="space-y-4">
                                <button onClick={() => onSelectRole('student')} className="w-full p-4 rounded border border-sky-900 bg-sky-900/20 text-white hover:bg-sky-900/40">Task Force Member</button>
                                <button onClick={() => onSelectRole('teacher')} className="w-full p-4 rounded border border-orange-900 bg-orange-900/20 text-white hover:bg-orange-900/40">Command Oversight</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { db, user, appId, error } = useFirebase();
            const [role, setRole] = useState(null); 
            const [globalSettings, setGlobalSettings] = useState({ currentWeek: 1 });

            useEffect(() => {
                if (!db || !appId || !user) return;
                const { doc, onSnapshot, setDoc } = window.firebaseModules;
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
                const unsub = onSnapshot(settingsRef, (snap) => {
                    if (snap.exists()) setGlobalSettings(snap.data());
                    else setDoc(settingsRef, { currentWeek: 1 }, { merge: true });
                }, (err) => console.error(err));
                return () => unsub();
            }, [db, appId, user]);

            if (error) return <div className="text-red-500">{error}</div>;
            if (!db || !user) return <div className="text-white">Loading...</div>;

            if (!role) return <LandingPage globalSettings={globalSettings} onSelectRole={setRole} />;
            return role === 'student' ? <StudentView db={db} user={user} appId={appId} globalSettings={globalSettings} onLogout={() => setRole(null)} /> : <TeacherView db={db} appId={appId} globalSettings={globalSettings} onLogout={() => setRole(null)} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
